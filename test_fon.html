<!DOCTYPE html>
<html lang="RU">
<meta charset="utf-8">

<head>
    <title>Муравей</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
          crossorigin="anonymous">

    <style>
        #canvas {
            background-image: url(pics/fon1.png);
            width: 400px;
            height: 400px;
            border: 1px;
            position: relative;
        }

        #ant {
            width: 50px;
            height: 50px;
            background-image: url(pics/ant_r.png);
            position: absolute;
            left: 0;
            top: 0;
        }
        #aLetter {
            width: 50px;
            height: 50px;
            background-image: url(pics/a.png);
            position: absolute;
            left: 150px;
            top: 150px;
            visibility: hidden;
        }

        #coding {
            color: blue;
            font-size: large;
        }
        #message {
            color: red;
            font-size: large;
        }

    </style>
</head>

<body>
    <div class="container">
        <div class="row justify-content-start">
            <div class="col align-self-start">
                <div class="btn-group-vertical" role="group" aria-label="Vertical button group">
                    <button type="button" class="btn btn-primary" onclick="addText('вправо')">вправо</button>
                    <button type="button" class="btn btn-primary" onclick="addText('влево')">влево</button>
                    <button type="button" class="btn btn-primary" onclick="addText('вверх')">вверх</button>
                    <button type="button" class="btn btn-primary" onclick="addText('вниз')">вниз</button>

                </div>
            </div>
            <div class="col">
                <label for="coding"></label><textarea rows="20" cols="30" id="coding"></textarea>
                <div class="btn-group" role="group" aria-label="Basic mixed styles example">
                    <button type="button" class="btn btn-primary" onclick="runCode()">Выполнить</button>
                    <button type="button" class="btn btn-warning" onclick="runCode()">Шаг</button>
                    <button type="button" class="btn btn-danger" onclick="stopCode()">Стоп</button>
                    <button type="button" class="btn btn-warning" onclick="delCode()">Очистить</button>
                </div>
                <label for="Velocity" class="form-label">Скорость движения</label>
                <input type="range" class="form-range" min="1" max="5" value="1" id="Velocity">
            </div>
            <div class="col">
                <label for="message"></label><textarea rows="20" cols="30" id="message"></textarea>
            </div>
            <div class="col align-self-start">
                <div id="canvas">
                    <div id="ant"></div>
                    <div id="aLetter"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="jquery.cookie.js"></script>
    <script>
        // let direction = "stop";
        let stepOn = false;
        let antTop = 0;
        let antLeft = 0;
        let codeLines;
        var animationId;
        $.cookie('codeLines');
        if(codeLines === undefined){
            code = document.getElementById("coding");
            code.value = "";
        }
        else{
            code = document.getElementById("coding");
            code.value = $.cookie('codeLines');
        }
        /* let map = [
            [1, 1, 0, 0, 0, 0, 0, 0],
            [0, 1, 1, 1, 1, 1, 0, 0],
            [0, 0, 0, 0, 0, 1, 0, 0],
            [0, 1, 1, 1, 1, 1, 0, 0],
            [0, 1, 0, 0, 0, 0, 0, 0],
            [0, 1, 0, 1, 1, 1, 1, 0],
            [0, 1, 1, 1, 0, 0, 1, 1],
            [0, 0, 0, 0, 0, 0, 0, 1]
        ];
        let objectLayer = [
            [9, 2, 2, 2, 2, 2, 2, 2],
            [2, 2, 2, 2, 2, 2, 2, 2],
            [2, 2, 2, 2, 2, 2, 2, 2],
            [2, 2, 2, 2, 2, 2, 2, 2],
            [2, 2, 2, 101, 2, 2, 2, 2],
            [2, 2, 2, 2, 2, 2, 2, 2],
            [2, 2, 2, 2, 2, 2, 2, 2],
            [2, 2, 2, 2, 2, 2, 2, 2]
        ];
         */
        function addText(text) {
            code = document.getElementById("coding");
            code.value += text + " \n";
        }

        function moveRight() {
            ant = document.getElementById("ant");
            ant.style.backgroundImage = "url('pics/ant_r.png')";
            ant.style.left = antLeft + 50 + "px";
        }

        function moveLeft() {
            ant = document.getElementById("ant");
            ant.style.backgroundImage = "url('pics/ant_l.png')";
            ant.style.left = antLeft - 50 + "px";
        }

        function moveUp() {
            ant = document.getElementById("ant");
            ant.style.top = antTop - 50 + "px";
        }

        function moveDown() {
            ant = document.getElementById("ant");
            ant.style.top = antTop + 50 + "px";
        }
        let m = function moving(step, lenPath, direction) {
            stepOn = true
            step++;
            if (direction === "вправо") {
                moveRight();
                antLeft += 50;
            } else if (direction === "влево") {
                moveLeft();
                antLeft -= 50;
            } else if (direction === "вверх") {
                moveUp();
                antTop -= 50;
            } else if (direction === "вниз") {
                moveDown();
                antTop += 50;
            }
            if (step < lenPath - 1) {
                setTimeout(m.bind(null, step, lenPath, direction), 500);
            } else {
                stepOn = false;
            }
        }

        let r = function running(code, line) {
            line++;
            let command;
            let direction;
            let lenPath;
            let step;
            if (line < code.length) {
                command = code[line].split(" ");
                direction = command[0];
                lenPath = command[1];
                step = -1;
                setTimeout(m.bind(null, step, lenPath, direction), 500);
                let i = 0;
                while (window.stepOn) {
                    i++;
                }
                setTimeout(r.bind(null, code, line), 500);
            }
        }
        function delCode() {
            code = document.getElementById("coding");
            code.value = "";
        }
        function stopCode(){
            if(!!animationId){
                cancelAnimationFrame(animationId);
            }
        }
        //TODO чтобы работал runCode
        // https://learn.javascript.ru/js-animation
        // https://css-tricks.com/using-requestanimationframe/
        function runCode() {
            let command;
            let lenPath;
            ant = document.getElementById("ant");
            ant.style.left = "0px";
            ant.style.top = "0px";
            antTop = 0;
            antLeft = 0;
            code = document.getElementById("coding");
            let message = document.getElementById("message");
            message.value = "";
            $.cookie('codeLines', code.value);
            let codeLines = code.value.split("\n");
            let steps = 0;
            codeLines.forEach((commandLine) => {
                if (commandLine.length > 5){
                    command = commandLine.split(" ");
                    lenPath = command[1];
                    steps += Number(lenPath);
                }
            });
            let velocity = document.getElementById("Velocity");
            let duration = 480 * steps / Number(velocity.value);
            alert(duration);
            codeLines.forEach( commandLine => {
                command = commandLine.split(" ");
                direction = command[0];
                lenPath = Number(command[1]);
                message.value += command[0] + "\n";
                // let dLeft;
                // let dTop;
                let timerId;
                if (direction === "вправо") {
                    timerId = setInterval(() => moveRight(), 500);
                } else if (direction === "влево") {
                    timerId = setInterval(() => moveLeft(), 5000);
                    setTimeout(() => { clearInterval(timerId); }, 5000 * (lenPath + 1));
                } else if (direction === "вверх") {
                    timerId = setInterval(() => moveUp(), 5000);
                    setTimeout(() => { clearInterval(timerId);}, 5000 * (lenPath + 1));
                } else if (direction === "вниз") {
                    timerId = setInterval(() => moveDown(), 5000);
                    setTimeout(() => { clearInterval(timerId);}, 5000 * (lenPath + 1));
                }
            });
        }
    </script>
</body>

</html>
